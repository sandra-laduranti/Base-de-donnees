/* TESTS OUF'TIM */

USE ouf_tim


/* PEUPLEMENT SECONDAIRE PAR EXECUTION DE PROCEDURES */

/*L2 ATIC 2013 GROUPE ouf_tim						 */
/*BdD ouf_tim										 */
/*Auteur(s): PATRICK POL BROCHEN ELISE				 */
/*Intégrateur: SANDRA LADURANTI						 */

/* Test de la procédure unitaire de Distinctions_creer */
USE ouf_tim
GO
EXEC Distinctions_creer
	@Nom='Palme d''Or',
	@Lieu='Cannes',
	@Annee=2012

-- SELECT * FROM Distinctions

/* Test de la procédure unitaire de Compte_creer */
USE ouf_tim
GO
EXEC Compte_creer
	@Numero_bancaire = '4785145200347855',
	@Montant = 55,
	@Somme_operations=0
	
-- SELECT * FROM Compte

/* Test de la procédure unitaire de Type_abonnement_creer */
USE ouf_tim
GO
EXEC Type_abonnement_creer
	@Nom = 'Pauvre',
	@Prix = 10,
	@Prix_location = 1,
	@Exemplaires_simultanes = 3,
	@Prix_retard = 1,
	@Duree_engagement = 72

-- SELECT * FROM Type_abonnement

/* Test de la procédure unitaire de Abonnement_creer */
USE ouf_tim
GO
Declare @creation DATETIME
SET @creation = CURRENT_TIMESTAMP;
Declare @expi DATETIME
SET @expi = @creation + '20:00:00';

EXEC Abonnement_creer
	@Date_creation=@creation,
	@Date_expiration=@expi,
	@FK_numcompte=7,
	@FK_type_abonnement ='premium'

-- SELECT * FROM Abonnement;

/* Test de la procédure unitaire de Edition_creer */
USE ouf_tim
GO
Declare @inser DATETIME
SET @inser = CURRENT_TIMESTAMP;
EXEC Edition_creer
	@Nom='Introuvable',
	@Annee_de_sortie=2013,
	@Duree_film =120,
	@limite_age=10,
    @Support = 'Bluray' ,
    @Date_insertion = @inser,
    @Type_couleur ='Couleur',
    @Type_son='5.1',
    @FK_titre= 'Intouchables',
    @FK_complement_titre = ''

-- SELECT * FROM Edition;

/* Test de la procédure charindex d'insertion_edition */
USE "ouf_tim"
GO
Declare @inser DATETIME
SET @inser = CURRENT_TIMESTAMP;

USE ouf_tim
GO
DECLARE @FK_titre NVARCHAR(50) = 'Gladiator',
		@FK_complement_titre NVARCHAR(50)='',
		@Nom NVARCHAR(50) = 'Empire Vision',
		@Annee_de_sortie INT = 2012,
		@Duree_film INT = 130,
		@limite_age INT = 16,
		@support NVARCHAR(50)= 'DVD',
		@Dinsertion DATETIME = CURRENT_TIMESTAMP,
		@Tcouleur NVARCHAR(50)='Couleur',
		@Tson NVARCHAR(50)='Dolby',
		@liste_Langue_audio NVARCHAR(1000) = 'Francais|Chinois|Anglais',
		@liste_Langue_sous_titre NVARCHAR(1000)= 'Francais|Chinois|Anglais'
		
EXEC dbo.a_insertion_edition @FK_titre, @FK_complement_titre, @Nom, @Annee_de_sortie, @Duree_film, @limite_age, @support, @Dinsertion, @Tcouleur, @Tson, @liste_Langue_audio, @liste_Langue_sous_titre

-- SELECT * FROM Edition
-- SELECT * FROM Langue_audio
-- SELECT * FROM Langue_sous_titre

/* Test de la procédure charindex d'insertion_edition */
USE "ouf_tim"
GO
Declare @inser DATETIME
SET @inser = CURRENT_TIMESTAMP;

USE ouf_tim
GO
DECLARE @FK_titre NVARCHAR(50) = 'X-Men',
		@FK_complement_titre NVARCHAR(50)='Le Commencement',
		@Nom NVARCHAR(50) = 'Extended',
		@Annee_de_sortie INT = 2011,
		@Duree_film INT = 150,
		@limite_age INT = 12,
		@support NVARCHAR(50)= 'DVD',
		@Dinsertion DATETIME = CURRENT_TIMESTAMP,
		@Tcouleur NVARCHAR(50)='Couleur',
		@Tson NVARCHAR(50)='5.1',
		@liste_Langue_audio NVARCHAR(1000) = 'Francais|Anglais|Finnois',
		@liste_Langue_sous_titre NVARCHAR(1000)= 'Francais|Anglais|Finnois'
		
EXEC dbo.a_insertion_edition @FK_titre, @FK_complement_titre, @Nom, @Annee_de_sortie, @Duree_film, @limite_age, @support, @Dinsertion, @Tcouleur, @Tson, @liste_Langue_audio, @liste_Langue_sous_titre

-- SELECT * FROM Edition
-- SELECT * FROM Langue_audio
-- SELECT * FROM Langue_sous_titre

/* Test de la procédure unitaire d'Exemplaires_creer */

USE "ouf_tim"
GO
EXEC exemplaires_creer
	@Date_approvisionnement= '2007-02-10',
	@Taux_usure= 0,
	@Disponibilite= 1,
	@Reserve = 0,
	@FK_numero_edition= 1
	
-- SELECT * FROM Exemplaires;

USE "ouf_tim"
GO
EXEC exemplaires_creer
	@Date_approvisionnement= '2012-08-10',
	@Taux_usure= 1,
	@Disponibilite= 1,
	@Reserve = 0,
	@FK_numero_edition= 2
	
-- SELECT * FROM Exemplaires;

USE "ouf_tim"
GO
EXEC exemplaires_creer
	@Date_approvisionnement= '2006-10-12',
	@Taux_usure= 2,
	@Disponibilite= 1,
	@Reserve = 0,
	@FK_numero_edition= 3
	
-- SELECT * FROM Exemplaires;

USE "ouf_tim"
GO
EXEC exemplaires_creer
	@Date_approvisionnement= '2011-11-11',
	@Taux_usure= 0,
	@Disponibilite= 1,
	@Reserve = 0,
	@FK_numero_edition= 4
	
-- SELECT * FROM Exemplaires;

USE "ouf_tim"
GO
EXEC exemplaires_creer
	@Date_approvisionnement= '2012-12-12',
	@Taux_usure= 2,
	@Disponibilite= 1,
	@Reserve = 0,
	@FK_numero_edition= 5
	
-- SELECT * FROM Exemplaires;

/* Test de la procédure charindex d'insertion_film */
USE ouf_tim
GO
DECLARE @Titre NVARCHAR(50) = 'Machinous',
		@Complement_titre NVARCHAR(50)='bidulous',
		@Annee INT = 2013,
		@Nationalite NVARCHAR (50)= 'Dalek',
		@Duree INT = 42,
		@liste_acteurs NVARCHAR(1000)= 'jeannette,elise,1995-12-12,madame,1997-12-12,noobette,lol,france|jeannetta,sandra,1995-12-12,madame,1997-12-12,pommedeterre,lol,france',
		@liste_realisateurs NVARCHAR(500)= 'jeannette,elise,1995-12-12,madame,1997-12-12,noobette,france|jeannetta,sandra,1995-12-12,madame,1997-12-12,pommedeterre,france',
		@liste_distinctions NVARCHAR(500)='cesar,paris,2000|oscar,berlin,2002',
		@liste_genres NVARCHAR(100)='Obiwan|Kenobi'
		
EXEC dbo.ajouter_film @Titre, @Complement_titre, @Annee, @Nationalite, @Duree, @liste_acteurs, @liste_realisateurs, @liste_distinctions, @liste_genres 

-- SELECT * FROM Films
-- SELECT * FROM Acteur
-- SELECT * FROM Realisateur
-- SELECT * FROM Distinctions
-- SELECT * FROM Genre

/* TESTS PAR ACTIONS DE L'UTILISATEUR */


/*L2 ATIC 2013 GROUPE ouf_tim						 */
/*BdD ouf_tim										 */
/* Test d'insertion d'un abonné avec compte et abonnement */
/*Auteur(s): LADURANTI SANDRA						 */
/*Intégrateur: SANDRA LADURANTI						 */

/* un abonné s'inscrit, on effectue son inscription par procedures unitaires en attendant la correction du charindex*/

USE "ouf_tim"
GO
EXEC Abonne_creer
    @Nom = 'Bochard',
    @Prenom = 'Stephanie',
    @Pseudo = 'Steph',
    @Date_de_naissance = '1990-07-21',
    @Sexe = 'Madame',
    @Numero_de_voie = '25',
    @Complement_de_voie = '',
    @Type_de_voie = 'rue',
    @Libelle = 'des papillons',
    @Complement_libelle = '',
    @Code_postal = '91800',
    @Ville = 'Brunoy',
    @Cedex = '',
    @Pays = 'France',
    @Numero_telephone = '0666666666',
    @Adresse_email = 'stephanie.bochard@gmail.com'

SELECT * FROM ABONNE WHERE Nom = 'Bochard'

USE "ouf_tim"
GO
EXEC Compte_creer
    @Numero_bancaire = '4285141337347969',
    @Montant = 500,
    @Somme_operations = 0

SELECT * FROM COMPTE WHERE Numero_bancaire = '4285141337347969'

USE "ouf_tim"
GO
Declare @inser DATETIME
SET @inser = CURRENT_TIMESTAMP;
Declare @expi DATETIME
SET @expi = CURRENT_TIMESTAMP+240;
EXEC Abonnement_creer
   @Date_creation = @inser,
   @Date_expiration = @expi,
   @FK_numcompte = 11,
   @FK_type_abonnement = 'Familiale'

SELECT * FROM Abonnement WHERE FK_numcompte = 11

use "ouf_tim"
GO
EXEC Souscrire_creer
   @FK_nom_abonne = 'Bochard',
   @FK_prenom = 'Stephanie',
   @FK_pseudo = 'Steph',
   @FK_num_abonnement = 8

SELECT * FROM Souscrire WHERE FK_nom_abonne = 'Bochard'

/* L'abonné a la tête dans les nuages et tente de se réinscrire*/

USE "ouf_tim"
GO
EXEC Abonne_creer
    @Nom = 'Bochard',
    @Prenom = 'Stephanie',
    @Pseudo = 'Steph',
    @Date_de_naissance = '1990-07-21',
    @Sexe = 'Madame',
    @Numero_de_voie = '25',
    @Complement_de_voie = '',
    @Type_de_voie = 'rue',
    @Libelle = 'des papillons',
    @Complement_libelle = '',
    @Code_postal = '91800',
    @Ville = 'Brunoy',
    @Cedex = '',
    @Pays = 'France',
    @Numero_telephone = '0666666666',
    @Adresse_email = 'stephanie.bochard@gmail.com'

SELECT * FROM ABONNE WHERE Nom = 'Bochard'

/* L'abonné a envie de louer un film */

USE "ouf_tim"
GO
EXEC insere_location
@Num_exem = 6,
@Num_abo = 8

SELECT * FROM Locations WHERE FK_exemplaire = 6

/* L'abonné retourne son film  en retard*/

USE "ouf_tim"
GO
Declare @retour DATETIME
SET @retour = CURRENT_TIMESTAMP;
EXEC retour_location_creer
	@Date_retour = @retour ,
	@FK_num_location =  4,
	@FK_num_abonnement = 8

SELECT * FROM Locations WHERE FK_exemplaire = 6
SELECT * FROM Retour_location WHERE FK_num_location = 4


/*L2 ATIC 2013 GROUPE ouf_tim								 */
/*BdD ouf_tim												 */
/* Test du TRIGGER 'declencheur_suppression_exemplaire_use'  */
/*Auteur(s): LADURANTI SANDRA								 */
/*Intégrateur: SANDRA LADURANTI								 */

/* Test du TRIGGER 'declencheur_suppression_exemplaire_use' après passage du taux d'usure d'un dvd à son taux max autorisé
* pour le tester notre abonné va relouer le film plusieurs fois car le film il 
* est trop bien */

USE "ouf_tim"
GO
EXEC insere_location
@Num_exem = 6,
@Num_abo = 8

SELECT * FROM Locations WHERE FK_exemplaire = 6

USE "ouf_tim"
GO
Declare @retour DATETIME
SET @retour = CURRENT_TIMESTAMP;
EXEC retour_location_creer
	@Date_retour = @retour ,
	@FK_num_location =  5,
	@FK_num_abonnement = 8

SELECT * FROM Locations WHERE FK_exemplaire = 6
SELECT * FROM Retour_location WHERE FK_num_location = 5
SELECT Taux_usure FROM Exemplaires WHERE Numero_exemplaire = 6

USE "ouf_tim"
GO
EXEC insere_location
@Num_exem = 6,
@Num_abo = 8

SELECT * FROM Locations WHERE FK_exemplaire = 6
SELECT Taux_usure FROM Exemplaires WHERE Numero_exemplaire = 6

USE "ouf_tim"
GO
Declare @retour DATETIME
SET @retour = CURRENT_TIMESTAMP;
EXEC retour_location_creer
	@Date_retour = @retour ,
	@FK_num_location =  6,
	@FK_num_abonnement = 8

SELECT * FROM Locations WHERE FK_exemplaire = 6
SELECT * FROM Retour_location WHERE FK_num_location = 6
SELECT Numero_exemplaire, Taux_usure, Supprimer FROM Exemplaires WHERE Numero_exemplaire = 6


/*L2 ATIC 2013 GROUPE ouf_tim								    */
/*BdD ouf_tim												    */
/* Test du TRIGGER 'declencheur_suppression_relance_decouvert'  */
/* et 'declencheur_relance_decouvert'						    */
/*Auteur(s): BROCHEN ELISE									    */
/*Intégrateur: SANDRA LADURANTI								    */ 

/* TEST COMPTE A 0 EUROS EFFECTUE LOCATION + RETOUR LOC --> RELANCE */

--Test insere_location
USE "ouf_tim"
GO
EXEC insere_location
  @Num_exem = 1,
  @Num_abo = 3
SELECT * FROM Locations WHERE FK_num_abonnement = 3

-- SELECT * FROM Abonnement
-- SELECT * FROM Exemplaires
-- SELECT * FROM Compte 

--Test retour_location
USE "ouf_tim"
GO
DECLARE @Dretour DATETIME
SET @Dretour = CURRENT_TIMESTAMP;
EXEC retour_location_creer
    @Date_retour = @Dretour,
    @FK_num_location = 7,
    @FK_num_abonnement = 3
    
SELECT * FROM Retour_location WHERE FK_num_location = 7

/* REAPPROVISIONNEMENT DU COMPTE */

/*TEST RELANCE AVEC COMPTE ENCORE NEGATIF*/
use "ouf_tim"
GO
UPDATE Compte 
SET Montant = -1
WHERE Numero_compte = 3
SELECT * FROM Compte WHERE Numero_compte = 3

/*TEST ANNULATION RELANCE LORSQUE COMPTE POSITIF*/

use "ouf_tim"
GO
UPDATE Compte 
SET Montant = 10
WHERE Numero_compte = 3
SELECT * FROM Compte WHERE Numero_compte = 3


/*L2 ATIC 2013 GROUPE ouf_tim						 */
/*BdD ouf_tim										 */
/*Procedure de test sur la modification d'un film    */
/*Auteur(s): PATRICK POL							 */
/*Intégrateur: PATRICK POL							 */

/* on insére en premier lieu un film, cependant le gestionnaire */
/* se trompe en tappant le nom et l'année */

USE ouf_tim
GO
DECLARE @Titre NVARCHAR(50) = 'RRRrrrrb!!!',
		@Complement_titre NVARCHAR(50)='',
		@Annee INT = 2001,
		@Nationalite NVARCHAR (50)= 'Française',
		@Duree INT = 98,
		@liste_acteurs NVARCHAR(1000)= 'Rouve,Jean-Paul,1967-01-26,monsieur,null, JP, acteur des robin des bois,france|Depardieu,Gérard,1948-12-27,monsieur,null,gerarou,française,france',
		@liste_realisateurs NVARCHAR(500)= 'Chabat ,Alain,1958-11-24,monsieur,null,français,france',
		@liste_distinctions NVARCHAR(500)='',
		@liste_genres NVARCHAR(100)='Comédie'
		
EXEC dbo.ajouter_film @Titre, @Complement_titre, @Annee, @Nationalite, @Duree, @liste_acteurs, @liste_realisateurs, @liste_distinctions, @liste_genres 
   
/* présentation des tables avant execution de la modification des elements du film */
/* pour ne pas changer un element taper '_' pour un varchar ou 0 pour un int */

SELECT * FROM Films	WHERE Titre = 'RRRrrrrb!!!'
SELECT * FROM Jouer WHERE FK_titre_film = 'RRRrrrrb!!!'
SELECT * FROM Realiser WHERE FK_titre_film = 'RRRrrrrb!!!'
SELECT * FROM Attribuer WHERE FK_titre_film = 'RRRrrrrb!!!'
SELECT * FROM Edition WHERE FK_titre = 'RRRrrrrb!!!' 

/* correction de RRRrrrrb!!! en RRRrrrr!!!*/
USE "ouf_tim"
GO
EXEC maj_film
	@Ancien_titre = 'RRRrrrrb!!!',
	@Ancien_comp_titre = '',
	
	@Nouveau_titre = 'RRRrrrr!!!',
	@Nouveau_comp_titre = '_',
	@Nouveau_annee = 2004,
	@Nouveau_nationalite = '_',
	@Nouveau_duree = 0

-- Select pour voir que la modification a bien été effectuée sur
-- Films, Jouer, Realiser, Attribuer, Edition
SELECT * FROM Films	WHERE Titre = 'RRRrrrr!!!'
SELECT * FROM Jouer WHERE FK_titre_film = 'RRRrrrr!!!'
SELECT * FROM Realiser WHERE FK_titre_film = 'RRRrrrr!!!'
SELECT * FROM Attribuer WHERE FK_titre_film = 'RRRrrrr!!!'
SELECT * FROM Edition WHERE FK_titre = 'RRRrrrr!!!'

/*L2 ATIC 2013 GROUPE ouf_tim						 */
/*BdD ouf_tim										 */
/*Procedure de test sur la modification d'un abonne  */
/*Auteur(s): PATRICK POL							 */
/*Testeur(s):PATRICK POL							 */
/*Intégrateur: PATRICK POL							 */

-- On crée un Abonnement pour qui sera rattacher à l'abonné Patrick via la jointure souscrire

USE "ouf_tim"
GO
Declare @inser DATETIME
SET @inser = CURRENT_TIMESTAMP;
Declare @expi DATETIME
SET @expi = CURRENT_TIMESTAMP+240;
EXEC Abonnement_creer
   @Date_creation = @inser,
   @Date_expiration = @expi,
   @FK_numcompte = 11,
   @FK_type_abonnement = 'Premium'

SELECT * FROM Abonnement WHERE FK_numcompte = 11

use "ouf_tim"
GO
EXEC Souscrire_creer
   @FK_nom_abonne = 'Bochard',
   @FK_prenom = 'Stephanie',
   @FK_pseudo = 'Steph',
   @FK_num_abonnement = 11

SELECT * FROM Souscrire WHERE FK_nom_abonne = 'Bochard'

/* Presentation de l'abonné avant la maj */
SELECT * FROM Abonne WHERE Nom = 'Bochard'
SELECT * FROM Souscrire WHERE FK_nom_abonne = 'Bochard'

/* Stephanie se marie à Veres elle change donc de nom */
/* Il y a donc modification de la clé primaire */
/* Stephanie déménage également */
USE "ouf_tim"
GO
EXEC maj_abonne
	@Ancien_nom = 'Bochard',
	@Ancien_prenom = 'Stephanie',
	@Ancien_pseudo = 'Steph',
	
	@Nouveau_nom = 'Veres',
	@Nouveau_prenom = 'Stephanie',
	@Nouveau_pseudo = 'Steph',
	@Nouveau_sexe = '_' ,
	@Nouveau_Numero_voie  = '_',
	@Nouveau_Complement_de_voie = '_' ,
	@Nouveau_Type_de_voie= '_' ,
	@Nouveau_Libelle = '_',
	@Nouveau_Complement_libelle = '_' ,
	@Nouveau_Code_postal= '_'  ,
	@Nouveau_Ville = '_' ,
	@Nouveau_Cedex = '_',
	@Nouveau_Pays = 'USA',
	@Nouveau_Numero_telephone = '_' ,
	@Nouveau_Adresse_email= '_' 

SELECT * FROM Abonne WHERE Nom = 'Veres'
SELECT * FROM Abonnement WHERE Numero_abonnement = 11
SELECT * FROM Souscrire WHERE FK_nom_abonne = 'Veres'

/*L2 ATIC 2013 GROUPE ouf_tim							*/
/*BdD ouf_tim											*/
/*Procedure de test sur la modification d'une edition	*/
/*Auteur(s): PATRICK POL								*/
/*Testeur(s):PATRICK POL								*/
/*Intégrateur: PATRICK POL								*/


-- Pour ne rien modifier on saisi '_' quand c'est un VARCHAR et 0 quand c'est un int

SELECT * FROM Edition WHERE Numero_edition = 1
SELECT * FROM Exemplaires WHERE FK_numero_edition = 1

USE "ouf_tim"
GO
EXEC maj_edition
	@Num_edition = 1,
	 @Nouveau_Nom = 'GOLDI',
     @Nouveau_Annee_de_sortie = 0,
     @Nouveau_Duree_film = 0,
     @Nouveau_limite_age = 0,
     @Nouveau_Support = 'DVD',
     @Nouveau_Type_couleur = '_',
     @Nouveau_Type_son = '_'
     
SELECT * FROM Edition WHERE Numero_edition = 1
SELECT * FROM Exemplaires WHERE FK_numero_edition = 1

/* test suppr abonné */

SELECT * FROM Abonne WHERE Nom = 'Amri'
SELECT * FROM Compte WHERE Numero_compte = 1
SELECT * FROM Abonnement WHERE Numero_abonnement = 1
SELECT * FROM Souscrire WHERE FK_num_abonnement = 1

USE "ouf_tim" 
GO
EXEC Suppression_abonne 
	@Nom_sup = 'Amri',
	@Prenom_sup = 'Zakaria',
	@Pseudo_sup = 'ZakariaA'

SELECT * FROM Abonne WHERE Nom = 'Amri'
SELECT * FROM Compte WHERE Numero_compte = 1
SELECT * FROM Abonnement WHERE Numero_abonnement = 1
SELECT * FROM Souscrire WHERE FK_num_abonnement = 1
